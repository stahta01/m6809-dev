_realname=exec09
pkgname=${_realname}
pkgver=0.92+c2.gc8d8eb9
pkgrel=1
pkgdesc='Motorola 6809 Simulator'
arch=(x86_64 i686)
url=https://github.com/nealcrook/exec09
license=('spdx:GPL-2.0-or-later')
depends=(libreadline)
makedepends=(
  gcc
  cmake
  make
  libreadline-devel
  git
)
source=("${_realname}"::"git+https://github.com/nealcrook/exec09.git#branch=trunk"
        '001-Add-CMakeLists.txt-and-config.h-inspired-files-from.patch'
        '002-Replace-m6809-run-with-exec09-in-source-and-wpc-run-.patch')
sha256sums=('SKIP'
            '2c3994902de61d9f810d532b63dfa4edd0a749dae9804dc354f52b181013d996'
            'f62f7429c2ac6d5028f73eac081fb0c9cd74efbdc077128737a8381a7509b609')

# Helper macros to help make tasks easier #
apply_patch_with_msg() {
  for _patch in "$@"
  do
    msg2 "Applying ${_patch}"
    patch -Nbp1 -i "${srcdir}/${_patch}"
  done
}

# Declare global variables; begin with underscore to avoid name conflicts
_git_base_commit=

pkgver() {
  cd "${srcdir}/${_realname}"
  local _version=$(head -n 80 config.h | grep 'PACKAGE_VERSION' | sed -e 's/.* //' | tr '\n' '.' | sed -e 's/\"//g' | sed 's/.$/\n/')

  printf "%s+c%s.g%s" ${_version} $(git rev-list --count ${_git_base_commit}..HEAD) $(git rev-parse --short ${_git_base_commit})
}

prepare() {
  cd "${srcdir}/${_realname}"

  _git_base_commit=$(git rev-parse HEAD)

  GIT_AM="git am --committer-date-is-author-date"

  ${GIT_AM} ${srcdir}/001-Add-CMakeLists.txt-and-config.h-inspired-files-from.patch
  ${GIT_AM} ${srcdir}/002-Replace-m6809-run-with-exec09-in-source-and-wpc-run-.patch
}

build() {
  cd "${srcdir}/${_realname}"

  cmake \
    -B "build-${CARCH}"

  cmake --build "build-${CARCH}"
}

package() {
  #cd "${srcdir}/${_realname}"

  mkdir -p "$pkgdir"/usr/bin

  cp ${srcdir}/${_realname}/build-${CARCH}/${_realname}.exe "$pkgdir"/usr/bin/

  #DESTDIR="$pkgdir" cmake --install "build-${CARCH}"
}
