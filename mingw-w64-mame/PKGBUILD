# Maintainer: Tim Stahlhut <stahta01@gmail.com>
# archlinux Maintainer:  Antonio Rojas
# archlinux Contributor: Sergej Pupykin
# archlinux Contributor: robb_force
# archlinux Contributor: JJDaNiMoTh
# Based on https://archlinux.org/packages/community/x86_64/mame/ and
#          https://aur.archlinux.org/packages/mame-git

_realname=mame

pkgbase=mingw-w64-${_realname}
pkgname=("${MINGW_PACKAGE_PREFIX}-${_realname}")
pkgver=0.264.r72.g3a40a6e572e
pkgrel=1
_sourcedir=mame-git
pkgdesc='Port of the popular Multiple Arcade Machine Emulator using SDL with OpenGL support (mingw-w64)'
url='https://mamedev.org/'
license=(GPL2)
arch=(x86_64)
makedepends=(
  "${MINGW_PACKAGE_PREFIX}-nasm"
  "${MINGW_PACKAGE_PREFIX}-python"
  "${MINGW_PACKAGE_PREFIX}-asio"
  "${MINGW_PACKAGE_PREFIX}-rapidjson"
  "${MINGW_PACKAGE_PREFIX}-glm"
  "${MINGW_PACKAGE_PREFIX}-SDL2_ttf"
  "${MINGW_PACKAGE_PREFIX}-qt6-base"
  "${MINGW_PACKAGE_PREFIX}-lua"
  "${MINGW_PACKAGE_PREFIX}-libutf8proc"
  "${MINGW_PACKAGE_PREFIX}-pugixml"
  "${MINGW_PACKAGE_PREFIX}-portmidi"
  "${MINGW_PACKAGE_PREFIX}-portaudio"
  "${MINGW_PACKAGE_PREFIX}-flac"
  #libpulse # ${MINGW_PACKAGE_PREFIX}-pulseaudio exists
)
source=(${_sourcedir}::'git+https://github.com/mamedev/mame.git')
        #mame.sh mame.svg)
sha256sums=('SKIP')
options=(!debug !lto) # debug build fails under ArchLinux

pkgver() {
    cd ${_sourcedir}

    git describe --long --tags | sed 's/\([^-]*-g\)/r\1/;s/-/./g;s/^\(mame\)\([0-9]\)/\2./'
}

prepare() {
  cd ${_sourcedir}
}

build() {
  cd ${_sourcedir}

  _MAME_TARGET=windows_x64
  _MAME_MINGW64=$MINGW_PREFIX

  CONFIG_ARCHITECTURE=x64 \
  MINGW=$MINGW_PREFIX \
  MINGW64=${_MAME_MINGW64} \
  make ${_MAME_TARGET} \
    VERBOSE=1 \
    NOWERROR=1 \
    OPTIMIZE=2 \
    TOOLS=0 \
    BUILDDIR=build-${MSYSTEM}
}

package_mame() {
  depends=(
    "${MINGW_PACKAGE_PREFIX}-flac"
    "${MINGW_PACKAGE_PREFIX}-SDL2_ttf"
    "${MINGW_PACKAGE_PREFIX}-qt6-base"
    "${MINGW_PACKAGE_PREFIX}-lua"
    "${MINGW_PACKAGE_PREFIX}-libutf8proc"
    "${MINGW_PACKAGE_PREFIX}-pugixml"
    "${MINGW_PACKAGE_PREFIX}-portmidi"
    "${MINGW_PACKAGE_PREFIX}-portaudio"
    "${MINGW_PACKAGE_PREFIX}-hicolor-icon-theme"
) 

  cd ${_sourcedir}

  # Install the mame script
  install -Dm755 "$srcdir"/$_realname.sh "$pkgdir"${MINGW_PREFIX}/bin/$_realname

  # Install the binaries
  install -Dm755 mame -t "$pkgdir"${MINGW_PREFIX}/lib/mame

  # Install the extra bits
  install -Dm644 src/osd/modules/opengl/shader/glsl*.*h -t "$pkgdir"${MINGW_PREFIX}/lib/$_realname/shader/
  cp -ar {artwork,bgfx,plugins,language,ctrlr,keymaps,hash} "$pkgdir"${MINGW_PREFIX}/lib/$_realname/

  # Include the license
  install -Dm644 docs/LICENSE "$pkgdir"${MINGW_PREFIX}/share/licenses/$_realname/LICENSE

  # FS#28203
  sed -i 's|KEYCODE_2_PAD|KEYCODE_2PAD|' "$pkgdir"${MINGW_PREFIX}/lib/mame/ctrlr/*.cfg
  sed -i 's|KEYCODE_4_PAD|KEYCODE_4PAD|' "$pkgdir"${MINGW_PREFIX}/lib/mame/ctrlr/*.cfg
  sed -i 's|KEYCODE_6_PAD|KEYCODE_6PAD|' "$pkgdir"${MINGW_PREFIX}/lib/mame/ctrlr/*.cfg
  sed -i 's|KEYCODE_8_PAD|KEYCODE_8PAD|' "$pkgdir"${MINGW_PREFIX}/lib/mame/ctrlr/*.cfg

  # documentation
  install -dm0755 "$pkgdir"${MINGW_PREFIX}/share/doc
  cp -a docs "$pkgdir"${MINGW_PREFIX}/share/doc/$_realname
  rm -r "$pkgdir"${MINGW_PREFIX}/share/doc/$_realname/man
  install -Dm644 docs/man/*.6* -t "$pkgdir"${MINGW_PREFIX}/share/man/man6/

  # install desktop file and icon
  #install -Dm644 "$srcdir"/mame.desktop -t "$pkgdir"${MINGW_PREFIX}/share/applications
  #install -Dm644 "$srcdir"/mame.svg -t "$pkgdir"${MINGW_PREFIX}/share/icons/hicolor/scalable/apps
}
